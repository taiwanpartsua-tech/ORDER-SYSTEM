/*
  # Додавання статусу "на звірці" для замовлень

  1. Зміни
    - Додаємо статус "на звірці" до CHECK обмеження для поля status в таблиці orders
  
  2. Причина
    - Коли прийомка переводиться на звірку (sent_for_settlement), замовлення в ній повинні отримати статус "на звірці"
    - Без цього статусу в обмеженні бази даних, оновлення буде заблоковано
  
  3. Статуси замовлень після зміни
    - 'в роботі на сьогодні'
    - 'на броні'
    - 'очікується'
    - 'прийнято сьогодні'
    - 'на складі'
    - 'в дорозі'
    - 'в вигрузці'
    - 'готово до відправки'
    - 'в активному прийомі'
    - 'на звірці' (НОВИЙ)
    - 'повернення'
    - 'проблемні'
    - 'анульовано'
*/

-- Видалення старого обмеження
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM pg_constraint 
    WHERE conname = 'orders_status_check'
  ) THEN
    ALTER TABLE orders DROP CONSTRAINT orders_status_check;
  END IF;
END $$;

-- Додавання нового обмеження з статусом "на звірці"
ALTER TABLE orders 
ADD CONSTRAINT orders_status_check 
CHECK (status IS NULL OR status IN (
  'в роботі на сьогодні',
  'на броні',
  'очікується',
  'прийнято сьогодні',
  'на складі',
  'в дорозі',
  'в вигрузці',
  'готово до відправки',
  'в активному прийомі',
  'на звірці',
  'повернення',
  'проблемні',
  'анульовано'
));